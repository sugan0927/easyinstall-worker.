#!/bin/bash
# postinst script for easyinstall
# This script runs after package installation

set -e

# Package metadata
PKG_NAME="easyinstall"
PKG_VERSION="3.0"

# ============================================
# Color definitions
# ============================================
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# ============================================
# Logging function
# ============================================
log() {
    echo -e "${GREEN}[${PKG_NAME}]${NC} $1"
    logger -t "easyinstall-postinst" "$1"
}

warn() {
    echo -e "${YELLOW}[${PKG_NAME} WARNING]${NC} $1"
    logger -t "easyinstall-postinst" "WARNING: $1"
}

error() {
    echo -e "${RED}[${PKG_NAME} ERROR]${NC} $1"
    logger -t "easyinstall-postinst" "ERROR: $1"
    exit 1
}

# ============================================
# Configuration paths
# ============================================
SHARE_DIR="/usr/share/easyinstall"
BIN_DIR="/usr/local/bin"
CONFIG_DIR="/etc/easyinstall"
LIB_DIR="/var/lib/easyinstall"
LOG_DIR="/var/log/easyinstall"
BACKUP_DIR="/var/backups/easyinstall"
HOOKS_DIR="$SHARE_DIR/hooks"
SYSTEMD_DIR="/lib/systemd/system"

# ============================================
# Main post-installation function
# ============================================
postinst_configure() {
    log "ðŸ“¦ Configuring EasyInstall package v$PKG_VERSION..."
    
    # ============================================
    # Create necessary directories
    # ============================================
    log "ðŸ“ Creating directory structure..."
    mkdir -p "$SHARE_DIR"
    mkdir -p "$BIN_DIR"
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$LIB_DIR"
    mkdir -p "$LOG_DIR"
    mkdir -p "$BACKUP_DIR"
    mkdir -p "$HOOKS_DIR"
    mkdir -p /var/www/html
    mkdir -p /var/www/sites
    mkdir -p /backups/{daily,weekly,monthly}
    mkdir -p /var/cache/nginx
    
    # ============================================
    # Set proper permissions
    # ============================================
    log "ðŸ”’ Setting permissions..."
    chmod 755 "$SHARE_DIR"
    chmod 755 "$BIN_DIR"
    chmod 755 "$CONFIG_DIR"
    chmod 755 "$LIB_DIR"
    chmod 755 "$LOG_DIR"
    chmod 755 "$BACKUP_DIR"
    chmod 755 "$HOOKS_DIR"
    chmod 755 /var/www/html
    chmod 755 /var/www/sites
    chmod 755 /backups
    chmod 755 /var/cache/nginx
    
    # ============================================
    # Create symbolic links
    # ============================================
    log "ðŸ”— Creating symbolic links..."
    
    # Main command
    if [ -f "$SHARE_DIR/easyinstall.sh" ]; then
        ln -sf "$SHARE_DIR/easyinstall.sh" "$BIN_DIR/easyinstall"
        chmod +x "$BIN_DIR/easyinstall"
        log "  âœ… Created easyinstall command"
    else
        warn "  âš ï¸  easyinstall.sh not found in $SHARE_DIR"
    fi
    
    # Package manager
    if [ -f "$SHARE_DIR/pkg-manager.sh" ]; then
        ln -sf "$SHARE_DIR/pkg-manager.sh" "$BIN_DIR/easy-pkg"
        chmod +x "$BIN_DIR/easy-pkg"
        log "  âœ… Created easy-pkg command"
    fi
    
    # ============================================
    # Create default configuration if not exists
    # ============================================
    if [ ! -f "$CONFIG_DIR/config" ]; then
        log "ðŸ“ Creating default configuration..."
        cat > "$CONFIG_DIR/config" <<EOF
# EasyInstall Configuration
# Generated: $(date)

# Installation paths
INSTALL_PATH="/usr/local/easyinstall"
BACKUP_PATH="$BACKUP_DIR"

# Auto-update settings
AUTO_UPDATE="true"
UPDATE_CHECK_INTERVAL="86400"  # 24 hours

# Service settings
ENABLE_AUTOHEAL="true"
MONITORING_INTERVAL="60"

# Backup settings
BACKUP_RETENTION_DAYS="7"
REMOTE_BACKUP_ENABLED="false"

# Security settings
ENABLE_MODSECURITY="true"
ENABLE_FAIL2BAN="true"
AUTO_UPDATE_KEYS="true"

# Performance settings
PHP_MEMORY_LIMIT="256M"
REDIS_MAXMEMORY="64mb"
MYSQL_BUFFER_POOL="64M"

# WordPress settings
ENABLE_THEME_EDITOR="true"  # Enable theme/plugin editor by default
DISABLE_XMLRPC="false"       # XML-RPC enabled by default
EOF
        chmod 644 "$CONFIG_DIR/config"
        log "  âœ… Created configuration file"
    fi
    
    # ============================================
    # Initialize package state
    # ============================================
    if [ ! -f "$LIB_DIR/installed" ]; then
        echo "{}" > "$LIB_DIR/installed"
        chmod 644 "$LIB_DIR/installed"
        log "  âœ… Initialized package state"
    fi
    
    # ============================================
    # Create hook scripts
    # ============================================
    log "ðŸ”§ Creating hook scripts..."
    
    # Theme editor enabler hook
    cat > "$HOOKS_DIR/enable-theme-editor.sh" <<'EOF'
#!/bin/bash
# Hook to ensure theme editor is enabled

WP_CONFIG="/var/www/html/wordpress/wp-config.php"

if [ -f "$WP_CONFIG" ]; then
    # Check if DISALLOW_FILE_EDIT is defined
    if grep -q "DISALLOW_FILE_EDIT" "$WP_CONFIG"; then
        # Set to false
        sed -i 's/define.*DISALLOW_FILE_EDIT.*true.*/define("DISALLOW_FILE_EDIT", false);/' "$WP_CONFIG"
        sed -i 's/define.*DISALLOW_FILE_EDIT.*TRUE.*/define("DISALLOW_FILE_EDIT", false);/' "$WP_CONFIG"
        echo "âœ… Theme editor enabled in main WordPress"
    else
        # Add before the "That's all" line
        sed -i "/.*That's all.*/i define('DISALLOW_FILE_EDIT', false);" "$WP_CONFIG"
        echo "âœ… Added theme editor to main WordPress config"
    fi
fi

# Check multi-sites
if [ -d "/var/www/sites" ]; then
    for site in /var/www/sites/*; do
        if [ -f "$site/public/wp-config.php" ]; then
            if grep -q "DISALLOW_FILE_EDIT" "$site/public/wp-config.php"; then
                sed -i 's/define.*DISALLOW_FILE_EDIT.*true.*/define("DISALLOW_FILE_EDIT", false);/' "$site/public/wp-config.php"
                sed -i 's/define.*DISALLOW_FILE_EDIT.*TRUE.*/define("DISALLOW_FILE_EDIT", false);/' "$site/public/wp-config.php"
                echo "âœ… Enabled editor for site: $(basename $site)"
            else
                sed -i "/.*That's all.*/i define('DISALLOW_FILE_EDIT', false);" "$site/public/wp-config.php"
                echo "âœ… Added editor to site: $(basename $site)"
            fi
        fi
    done
fi
EOF
    chmod +x "$HOOKS_DIR/enable-theme-editor.sh"
    
    # Post-install main hook
    cat > "$HOOKS_DIR/post-install.sh" <<'EOF'
#!/bin/bash
# Main post-installation hook

echo "ðŸ”§ Running post-installation tasks..."

# Source configuration
CONFIG_DIR="/etc/easyinstall"
[ -f "$CONFIG_DIR/config" ] && source "$CONFIG_DIR/config"

# Run theme editor hook
if [ -f "/usr/share/easyinstall/hooks/enable-theme-editor.sh" ]; then
    bash "/usr/share/easyinstall/hooks/enable-theme-editor.sh"
fi

# Create default index page if not exists
if [ ! -f "/var/www/html/index.html" ]; then
    cat > "/var/www/html/index.html" <<HTML
<!DOCTYPE html>
<html>
<head>
    <title>EasyInstall Server</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        h1 { color: #333; }
        .info { background: #f4f4f4; padding: 20px; border-radius: 5px; }
        code { background: #e0e0e0; padding: 2px 5px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>ðŸš€ EasyInstall Server</h1>
    <div class="info">
        <p>Your server is ready! To install WordPress:</p>
        <code>easyinstall domain yourdomain.com</code>
        <p>For help: <code>easyinstall help</code></p>
    </div>
</body>
</html>
HTML
    echo "âœ… Created default index page"
fi

echo "âœ… Post-installation complete"
EOF
    chmod +x "$HOOKS_DIR/post-install.sh"
    
    # ============================================
    # Create systemd service if not exists
    # ============================================
    if [ ! -f "$SYSTEMD_DIR/autoheal.service" ] && [ -f "$SHARE_DIR/autoheal.service" ]; then
        log "âš™ï¸  Installing systemd service..."
        cp "$SHARE_DIR/autoheal.service" "$SYSTEMD_DIR/"
        chmod 644 "$SYSTEMD_DIR/autoheal.service"
        systemctl daemon-reload
        log "  âœ… Installed autoheal service"
    fi
    
    # ============================================
    # Add bash aliases
    # ============================================
    log "ðŸ”§ Adding bash aliases..."
    if ! grep -q "alias e='easyinstall'" /root/.bashrc 2>/dev/null; then
        echo "" >> /root/.bashrc
        echo "# EasyInstall aliases" >> /root/.bashrc
        echo "alias e='easyinstall'" >> /root/.bashrc
        echo "alias eb='easyinstall backup'" >> /root/.bashrc
        echo "alias er='easyinstall restore'" >> /root/.bashrc
        echo "alias es='easyinstall status'" >> /root/.bashrc
        echo "alias ere='easyinstall report'" >> /root/.bashrc
        log "  âœ… Added bash aliases"
    fi
    
    # ============================================
    # Check for required commands
    # ============================================
    log "ðŸ” Checking dependencies..."
    MISSING_DEPS=""
    for cmd in curl wget systemctl; do
        if ! command -v $cmd >/dev/null 2>&1; then
            MISSING_DEPS="$MISSING_DEPS $cmd"
        fi
    done
    
    if [ -n "$MISSING_DEPS" ]; then
        warn "  âš ï¸  Missing commands:$MISSING_DEPS"
        warn "     Run: apt-get install -f"
    else
        log "  âœ… All core dependencies present"
    fi
    
    # ============================================
    # Run post-install hook
    # ============================================
    if [ -f "$HOOKS_DIR/post-install.sh" ]; then
        log "ðŸƒ Running post-install hooks..."
        bash "$HOOKS_DIR/post-install.sh"
    fi
    
    # ============================================
    # Display success message
    # ============================================
    echo ""
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}âœ… EasyInstall Package v$PKG_VERSION Installed!${NC}"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${CYAN}Quick Start:${NC}"
    echo "  easyinstall help              - Show all commands"
    echo "  easyinstall status            - Check system status"
    echo "  easyinstall domain example.com - Install WordPress"
    echo ""
    echo -e "${CYAN}Package Management:${NC}"
    echo "  easy-pkg --pkg-status        - Check package status"
    echo "  easy-pkg --pkg-verify        - Verify installation"
    echo "  easy-pkg --pkg-backup        - Backup configuration"
    echo ""
    echo -e "${CYAN}Features:${NC}"
    echo "  â€¢ Theme/Plugin Editor: ${GREEN}ENABLED${NC}"
    echo "  â€¢ XML-RPC: ${GREEN}ENABLED${NC} (use 'easyinstall xmlrpc disable' to block)"
    echo "  â€¢ Auto-healing: ${GREEN}ENABLED${NC}"
    echo "  â€¢ Multi-site panel: ${GREEN}AVAILABLE${NC}"
    echo ""
    echo -e "${YELLOW}Note:${NC} Run 'easyinstall' to complete the full setup"
    echo -e "${GREEN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# ============================================
# Post-installation removal/upgrade handling
# ============================================
postinst_abort() {
    log "âš ï¸  Installation aborted"
    exit 0
}

# ============================================
# Main case statement
# ============================================
case "$1" in
    configure)
        postinst_configure
        ;;
    
    abort-upgrade|abort-remove|abort-deconfigure)
        postinst_abort
        ;;
    
    triggered)
        # Handle triggers if needed
        log "ðŸ”„ Processing triggers..."
        ;;
    
    *)
        echo "postinst called with unknown argument '$1'" >&2
        exit 1
        ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0